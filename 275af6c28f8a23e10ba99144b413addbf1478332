{
  "comments": [
    {
      "key": {
        "uuid": "d2fd8bfe_ce7037c6",
        "filename": "/COMMIT_MSG",
        "patchSetId": 15
      },
      "lineNbr": 7,
      "author": {
        "id": 1003935
      },
      "writtenOn": "2017-02-27T17:05:07Z",
      "side": 1,
      "message": "Have you considered to store the plugin configuration in a Git config file, instead of using YAML?\n\nE.g. if the config would be stored in a \u0027automerger.config\u0027 Git config file in the \u0027refs/meta/config\u0027 branch of the \u0027All-Projects\u0027 repository, you could simply use PluginConfigFactory.getProjectPluginConfig(...) from Gerrit core to load the config [1]. The loaded config would be automatically cached as part of the ProjectState in the project cache. So you wouldn\u0027t need to worry about reloading and caching the config at all.\n\n[1] https://gerrit-review.googlesource.com/Documentation/dev-plugins.html#project-specific-configuration",
      "revId": "275af6c28f8a23e10ba99144b413addbf1478332",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "9415a97c_1a20a881",
        "filename": "/COMMIT_MSG",
        "patchSetId": 15
      },
      "lineNbr": 7,
      "author": {
        "id": 1019952
      },
      "writtenOn": "2017-02-27T19:49:34Z",
      "side": 1,
      "message": "This looks like a very good idea. On it!",
      "parentUuid": "d2fd8bfe_ce7037c6",
      "revId": "275af6c28f8a23e10ba99144b413addbf1478332",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "36072ab9_0572ba15",
        "filename": "/COMMIT_MSG",
        "patchSetId": 15
      },
      "lineNbr": 7,
      "author": {
        "id": 1019952
      },
      "writtenOn": "2017-02-28T19:21:25Z",
      "side": 1,
      "message": "Would it be okay if I did this in a followup CL? We\u0027re hoping to deploy this fix relatively soon so we can start rolling it out. Just learned about a deadline today \u003d/",
      "parentUuid": "9415a97c_1a20a881",
      "revId": "275af6c28f8a23e10ba99144b413addbf1478332",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "46a045f9_2fbed00e",
        "filename": "/COMMIT_MSG",
        "patchSetId": 15
      },
      "lineNbr": 7,
      "author": {
        "id": 1019952
      },
      "writtenOn": "2017-03-03T02:17:46Z",
      "side": 1,
      "message": "Using Git config now. Removed dependency on SnakeYAML.",
      "parentUuid": "36072ab9_0572ba15",
      "revId": "275af6c28f8a23e10ba99144b413addbf1478332",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "9832f062_4c1534ba",
        "filename": "src/main/java/com/googlesource/gerrit/plugins/automerger/ConfigLoader.java",
        "patchSetId": 15
      },
      "lineNbr": 89,
      "author": {
        "id": 1003935
      },
      "writtenOn": "2017-02-27T17:05:07Z",
      "side": 1,
      "message": "Why is key not used?",
      "range": {
        "startLine": 89,
        "startChar": 44,
        "endLine": 89,
        "endChar": 47
      },
      "revId": "275af6c28f8a23e10ba99144b413addbf1478332",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "b547323a_4df6c0a2",
        "filename": "src/main/java/com/googlesource/gerrit/plugins/automerger/ConfigLoader.java",
        "patchSetId": 15
      },
      "lineNbr": 89,
      "author": {
        "id": 1019952
      },
      "writtenOn": "2017-02-28T19:21:25Z",
      "side": 1,
      "message": "It\u0027s pretty much there so that, when \"key\" changes, we grab the newest config. The actual value of the key doesn\u0027t matter so much as that it\u0027s not the same as the previous.",
      "parentUuid": "9832f062_4c1534ba",
      "range": {
        "startLine": 89,
        "startChar": 44,
        "endLine": 89,
        "endChar": 47
      },
      "revId": "275af6c28f8a23e10ba99144b413addbf1478332",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "1f7a0b1b_d6a34f74",
        "filename": "src/main/java/com/googlesource/gerrit/plugins/automerger/ConfigLoader.java",
        "patchSetId": 15
      },
      "lineNbr": 107,
      "author": {
        "id": 1003935
      },
      "writtenOn": "2017-02-27T17:05:07Z",
      "side": 1,
      "message": "[optional] Instead of hard-coding the plugin name you may get it injected with \n\n  @PluginName String pluginName",
      "range": {
        "startLine": 107,
        "startChar": 43,
        "endLine": 107,
        "endChar": 53
      },
      "revId": "275af6c28f8a23e10ba99144b413addbf1478332",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "f3378a82_54506661",
        "filename": "src/main/java/com/googlesource/gerrit/plugins/automerger/ConfigLoader.java",
        "patchSetId": 15
      },
      "lineNbr": 107,
      "author": {
        "id": 1019952
      },
      "writtenOn": "2017-02-28T19:21:25Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "1f7a0b1b_d6a34f74",
      "range": {
        "startLine": 107,
        "startChar": 43,
        "endLine": 107,
        "endChar": 53
      },
      "revId": "275af6c28f8a23e10ba99144b413addbf1478332",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "c7692fde_30aefdad",
        "filename": "src/main/java/com/googlesource/gerrit/plugins/automerger/DownstreamCreator.java",
        "patchSetId": 15
      },
      "lineNbr": 72,
      "author": {
        "id": 1003935
      },
      "writtenOn": "2017-02-27T17:05:07Z",
      "side": 1,
      "message": "not used",
      "range": {
        "startLine": 72,
        "startChar": 64,
        "endLine": 72,
        "endChar": 89
      },
      "revId": "275af6c28f8a23e10ba99144b413addbf1478332",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "e4ed35dc_a3141204",
        "filename": "src/main/java/com/googlesource/gerrit/plugins/automerger/DownstreamCreator.java",
        "patchSetId": 15
      },
      "lineNbr": 72,
      "author": {
        "id": 1019952
      },
      "writtenOn": "2017-02-28T19:21:25Z",
      "side": 1,
      "message": "Whoops, meant to delete that. Done.",
      "parentUuid": "c7692fde_30aefdad",
      "range": {
        "startLine": 72,
        "startChar": 64,
        "endLine": 72,
        "endChar": 89
      },
      "revId": "275af6c28f8a23e10ba99144b413addbf1478332",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "ca7698e3_41d1e6c7",
        "filename": "src/main/java/com/googlesource/gerrit/plugins/automerger/LoadedConfig.java",
        "patchSetId": 15
      },
      "lineNbr": 54,
      "author": {
        "id": 1011842
      },
      "writtenOn": "2017-02-28T20:13:08Z",
      "side": 1,
      "message": "I don\u0027t think this works for refs/meta/config. /branches/* matches against refs/heads/*: https://gerrit.googlesource.com/gerrit/+/a2cfc65301a9a534c4d0a08d2524fa048bcbd92e/gerrit-server/src/main/java/com/google/gerrit/server/project/BranchesCollection.java#64\n\nekempin\u0027s suggestion sounds simpler. An alternative is to open the project directly: \n\n      GitRepositoryManager mgr;\n      try (Repository repo \u003d mgr.openRepository(name); RevWalk rw \u003d new RevWalk(repo)) {\n        RevCommit revision \u003d rw.parseCommit(rev);\n        TreeWalk tw \u003d TreeWalk.forPath(rw.getObjectReader(), configFilename, revision.getTree());\n        if (tw !\u003d null) {\n          ObjectLoader obj \u003d reader.open(tw.getObjectId(0), Constants.OBJ_BLOB);\n          return RawParseUtils.decode(obj.getCachedBytes(Integer.MAX_VALUE));\n        }\n        return \"\";\n      }\n\nAnother nice effect here is that rev can be the sha1 you obtained from ProjectConfig, to avoid caches getting confused.",
      "revId": "275af6c28f8a23e10ba99144b413addbf1478332",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "ab9b37cf_9b4a3382",
        "filename": "src/main/java/com/googlesource/gerrit/plugins/automerger/LoadedConfig.java",
        "patchSetId": 15
      },
      "lineNbr": 54,
      "author": {
        "id": 1019952
      },
      "writtenOn": "2017-02-28T21:22:57Z",
      "side": 1,
      "message": "...Huh. It seems to work locally, though. I wonder why that is?",
      "parentUuid": "ca7698e3_41d1e6c7",
      "revId": "275af6c28f8a23e10ba99144b413addbf1478332",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "cc4ddaf2_d8c71949",
        "filename": "src/main/java/com/googlesource/gerrit/plugins/automerger/LoadedConfig.java",
        "patchSetId": 15
      },
      "lineNbr": 54,
      "author": {
        "id": 1019952
      },
      "writtenOn": "2017-02-28T21:29:50Z",
      "side": 1,
      "message": "Re: Not working\nI\u0027ve tested it on local (only changing refs/meta/config) and it seems to work fine. I have no idea why, but the evidence doesn\u0027t lie (unless there\u0027s some reason that wouldn\u0027t hold true on prod).\n\n\nRe using git config:\nekempin\u0027s solution requires a refactoring of how the YAML config file works, since AFAICT it doesn\u0027t let me nest things.\n\ni.e. it won\u0027t let me do this\n\n[automerger \"branch1\"]\n  [\"branch2\"]\n    merge \u003d false\n    limitEmails \u003d \"stephenli@google.com\"\n  [\"branch3\"]\n    merge \u003d true\n    limitEmails \u003d \"test@example.com\"\n\n\nThat\u0027s not necessarily a blocker; I may be able to hack around it with something like:\n[automerger \"branch1.branch2\"]\n  merge \u003d false\n  limitEmails \u003d stephenli@google.com\n[automerger \"branch1.branch3\"]\n  merge \u003d true\n  limitEmails \u003d test@example.com\n\nbut the current code relies on being able to find the destination branches (i.e. given branch1, return branch2 and branch3) so it\u0027s not a simple change.\n\nIn the meantime I want to get something working on prod, since we\u0027re looking to have this live in a week or two.",
      "parentUuid": "ab9b37cf_9b4a3382",
      "revId": "275af6c28f8a23e10ba99144b413addbf1478332",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "02dd85b5_77cf4623",
        "filename": "src/main/java/com/googlesource/gerrit/plugins/automerger/LoadedConfig.java",
        "patchSetId": 15
      },
      "lineNbr": 54,
      "author": {
        "id": 1011842
      },
      "writtenOn": "2017-02-28T22:06:08Z",
      "side": 1,
      "message": "Ah, you\u0027re right. ListBranches special-cases refs/meta/config.",
      "parentUuid": "cc4ddaf2_d8c71949",
      "revId": "275af6c28f8a23e10ba99144b413addbf1478332",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": false
    }
  ]
}